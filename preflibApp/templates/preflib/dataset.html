{% load static %}
{% load extratags %}

<!DOCTYPE html>
<html>
<head>
	{% include 'includes/htmlHeaderContent.html' %}
	<title>Preflib</title>
</head>

<body>

{% include 'includes/header.html' %}

<div class="content">
<h1>{{ dataset.category }}-{{ dataset.seriesNumber }}: {{ dataset.name }}</h1>

<div class="indexContent-wrap">
	<div class="indexMainContent">
		{% autoescape off %}
		<p>{{ dataset.description }}</p>
		{% endautoescape %}

		{% if dataset.requiredCitations %}
			{% autoescape off %}
			<p><span style="font-weight: bold;">Required citations:</span> {{ dataset.requiredCitations }} </p>	
			{% endautoescape %}
		{% endif %}

		{% if dataset.requiredCitations %}
			{% autoescape off %}
			<p><span style="font-weight: bold;">Selected studies:</span> {{ dataset.selectedStudies }} </p>
			{% endautoescape %}
		{% endif %}

		<p id="center_p" style="margin-top: 30px;"><a href="{% static zipfilepath %}" class="downloadButton">Download the dataset [zip, {{ totalSize|filesizeformat }}]</a></p>
	</div>

	<div class="indexRightContent">
		<h2>Details</h2>
		<ul>
			<li> Number of files: {{ nbFiles }}</li>
			<li> Total size: {{ totalSize|filesizeformat }}</li>
			<li> Data types:
				{% for dataType in allTypes %}
					{% if forloop.last %}
						<a href="{% url 'preflibapp:datatypes' %}#{{dataType.0}}">{{ dataType.0 }}</a>.
					{% else %}
						<a href="{% url 'preflibapp:datatypes' %}#{{dataType.0}}">{{ dataType.0 }}</a>,
					{% endif %}
				{% endfor %} 
			</li>
			<li> Publication date: {{ dataset.publicationDate }} </li>
			<li> Last modification: {{ dataset.modificationDate }} </li>
		</ul>
	</div>
</div>

<h2>All the patches of the dataset </h2>

{% include 'includes/paginator.html' %}

<div class="patchGrid">

	{% for patch in patches %}
		<div class="patchCell">
			<h3><a href="{% url 'preflibapp:datapatch' dataset.category dataset.seriesNumber patch.seriesNumber %}">{{ patch.name }}: <span>{{ patch.description }}</span></a></h3>

			<div class="patchCellContent">

				{% with patch.datafile_set.all|dictsortreversed:"dataType"|dictsortreversed:"modificationType" as sortedFiles %}

					{% with patch_num_vot_alt|keyvalue:patch as num_vot_alt %}
						{% if num_vot_alt %}
							<table align="center" class="patchtable">
								<tr>
									<th class="patchtable-header">#Voters</th>
									<th class="patchtable-header">#Alternatives</th>
								</tr>
								<tr>
									<td>{{ num_vot_alt.1 }}</td>
									<td>{{ num_vot_alt.0 }}</td>
								</tr>
							</table>
						{% endif %}
					{% endwith %}

					<p>
						{% with 'data/'|add:dataset.category|add:'/'|add:dataset.abbreviation|add:'/img/'|add:patch.representative.image as imgFile %}
							{% if imgFile %}
								<a href="{% url 'preflibapp:datapatch' dataset.category dataset.seriesNumber patch.seriesNumber %}"><img src="{% static imgFile %}"></a>
							{% endif %}
						{% endwith %}
					</p>

					<table align="center" class="patchtable">
						<tr>
							<th class="patchtable-header">Modification</th>
							<th class="patchtable-header">Type</th>
							<th class="patchtable-header"></th>
						</tr>
						{% for file in sortedFiles %}
							<tr>
								<td><a href="{% url 'preflibapp:dataFormat'%}#modification">{{ file.modificationType }}</a></td>
								<td><a href="{% url 'preflibapp:datatypes'%}#{{file.dataType}}">{{ file.dataType }}</a></td>
								{% with 'data/'|add:dataset.category|add:'/'|add:dataset.abbreviation|add:'/'|add:file.fileName as f %}
									<td><a href="{% static f %}" class="downloadButton">Download [{{ file.fileSize|filesizeformat }}]</a></td>
								{% endwith %}
							</tr>
						{% endfor %}
					</table>

					<p>Learn more about this data patch <a href="{% url 'preflibapp:datapatch' dataset.category dataset.seriesNumber patch.seriesNumber %}">on this page</a>.</p>
				{% endwith %}
			</div>
		</div>
	{% endfor %}
</div>

{% include 'includes/paginator.html' %}

</div>
</body>

{% include 'includes/footer.html' %}

</html>