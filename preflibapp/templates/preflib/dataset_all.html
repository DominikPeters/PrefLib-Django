{% load static %}

<!DOCTYPE html>
<html>
<head>
	{% include 'includes/htmlheadercontent.html' %}
	<title>Preflib</title>
</head>

<body>

{% include 'includes/header.html' %}

<div class="content">

<h1> Datasets </h1>

{% if datasets %}

	<p>
        Sort by:
        <a href="javascript:sortByName()" id="sort-name" style="font-weight: bold;">Dataset name (A-Z)</a> &middot;
        <a href="javascript:sortByNew()" id="sort-new">Newest first</a> &middot;
        <a href="javascript:sortByOld()" id="sort-old">Oldest first</a>
    </p>
	
	<section id="section-datasets">
	<nav id="dataset-menu">
		<ul>
			{% for ds in datasets %}
				<li data-number="{{ds.series_number}}" data-name="{{ds.name}}"><a href="#{{ds.series_number}}">{{ ds.name }}</a></li>
			{% endfor %}
		</ul>
	</nav>
	
	<ul id="dataset-list">
	{% for dsinfo in dataset_info %}
		{% with dsinfo.ds as ds %}
			<li id="{{ ds.series_number }}" data-number="{{ ds.series_number }}" data-name="{{ ds.name }}">
				<h2 class="dataset-title"><a href="{% url 'preflibapp:dataset' ds.series_number %}" id="{{ ds.series_number }}_title">{{ ds.name }}</a></h2>

				<p class="dataset-number">{{ds.series_number}}</p>

				{% if ds.tags %}
					<p class="dataset-tags">
						{% for tag in ds.tags.all %}
							<span class="data-tag">{{ tag.name }}</span>
						{% endfor %}
					</p>
				{% endif %}

				<div class="dataset-description">
				{% autoescape off %}
					{{ ds.description }}
				{% endautoescape %}
				</div>

				<p class="data-file-list">
					Consists of {{ dsinfo.num_files }} data file{{ dsinfo.num_files|pluralize:"s" }}:
					{% for file in dsinfo.files %}
						<span class="data-file">{{ file.title }}</span>
					{% endfor %}
					{% if dsinfo.num_hidden_files > 0 %}
						and <a href="{% url 'preflibapp:dataset' ds.series_number %}">{{ dsinfo.num_hidden_files }} more</a>.
					{% endif %}
				</p>

				<div class="button-row">
					<a href="{% url 'preflibapp:dataset' ds.series_number %}" class="download-button">Details</a>
					<a href="{% static dsinfo.zip_file %}" class="download-button">Download [zip, {{dsinfo.zip_file_size|filesizeformat}}]</a>
				</div>
			</li>
		{% endwith %}
	{% endfor %}
	</ul>
	</section>

	<script>
		// sorting
		var list = document.querySelector('#dataset-list');
		var menu = document.querySelector('#dataset-menu ul');

		function bolden(id) {
			for (link of ["#sort-name", "#sort-new", "#sort-old"]) {
				if (link == id) {
					document.querySelector(link).style.fontWeight = "bold";
				} else {
					document.querySelector(link).style.fontWeight = "normal";
				}
			}
		}

		function sortByName() {
			[...list.children]
			.sort((a,b)=>a.dataset.name.localeCompare(b.dataset.name))
			.forEach(node=>list.appendChild(node));
			[...menu.children]
			.sort((a,b)=>a.dataset.name.localeCompare(b.dataset.name))
			.forEach(node=>menu.appendChild(node));
			bolden("#sort-name");
		}
		function sortByNew() {
			[...list.children]
			.sort((a,b)=>b.dataset.number.localeCompare(a.dataset.number))
			.forEach(node=>list.appendChild(node));
			[...menu.children]
			.sort((a,b)=>b.dataset.number.localeCompare(a.dataset.number))
			.forEach(node=>menu.appendChild(node));
			bolden("#sort-new");
		}
		function sortByOld() {
			[...list.children]
			.sort((a,b)=>a.dataset.number.localeCompare(b.dataset.number))
			.forEach(node=>list.appendChild(node));
			[...menu.children]
			.sort((a,b)=>a.dataset.number.localeCompare(b.dataset.number))
			.forEach(node=>menu.appendChild(node));
			bolden("#sort-old");
		}

		// menu updates
		function debounce(func, timeout = 300) {
			let timer;
			return (...args) => {
				clearTimeout(timer);
				timer = setTimeout(() => {
				func.apply(this, args);
				}, timeout);
			};
		}

		function updateDatasetMenu() {
			var current = "NOTHING";

			// figure out where we are
			document.querySelectorAll("#dataset-list > li").forEach((section) => {
				const sectionTop = section.offsetTop;
				if (scrollY >= sectionTop - 122) {
					current = section.dataset.number;
				}
			});

			// show current element in menu
			document.querySelectorAll("#dataset-menu ul li").forEach((li) => {
				li.classList.remove("current");
				if (li.dataset.number == current) {
					li.classList.add("current");
					li.scrollIntoView({ block: "nearest" });
				}
			});
		}

		document.addEventListener("DOMContentLoaded", (event) => {
			window.onscroll = () => {
				debounce(updateDatasetMenu, 75)();
			};
		});

	</script>

{% else %}
	<p> There are no datasets yet. Do you want to contribute? </p>
{% endif %}

</div>
</body>

{% include 'includes/footer.html' %}

</html>